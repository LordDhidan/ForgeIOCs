<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ForgeIOC — Offline IOC Parser</title>
<meta name="description" content="ForgeIOC: Offline IOC parser with clean outputs and optional FortiGate CLI generation. Created by Dhaidan Aljumah."/>
<style>
  :root{--bg:#0b0b0b;--card:#121212;--card2:#0f0f0f;--muted:#a1a1aa;--text:#f4f4f5;--border:#232326;--accent:#ff8a00;--good:#22c55e;--bad:#ef4444;--input:#0e0e0e;--shadow: 0 10px 30px rgba(0,0,0,.45);}
  [data-theme="light"]{--bg:#f6f7f9;--card:#ffffff;--card2:#ffffff;--muted:#475569;--text:#0b0b0b;--border:#e5e7eb;--accent:#ff8a00;--good:#16a34a;--bad:#dc2626;--input:#ffffff;--shadow: 0 8px 22px rgba(0,0,0,.08);}

  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif;background:var(--bg);color:var(--text);}
  header{padding:28px 18px 10px;max-width:1200px;margin:0 auto;}
  h1{margin:0;font-size:28px;letter-spacing:.2px}
  .sub{margin:8px 0 0;color:var(--muted);line-height:1.5}
  .creator{margin-top:10px;color:var(--muted);font-size:13px}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 18px 30px;display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
   .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 14px 12px;backdrop-filter: blur(6px);}
  .card h2{margin:0 0 10px;font-size:16px}
  textarea{width:100%;min-height:240px;resize:vertical;background:var(--input);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px;line-height:1.45}
  input,select{background:var(--input);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:9px 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1}
  .btn{cursor:pointer;border:1px solid var(--border);background:linear-gradient(180deg,var(--border),var(--border));color:var(--text);padding:10px 12px;border-radius:12px;font-weight:600}
  .btn:hover{border-color:var(--border)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#0b0b0b;box-shadow:0 8px 18px rgba(255,138,0,.18)}
  .btn.ghost{background:transparent}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:7px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .small{font-size:12px;color:var(--muted)}
  .counts{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .count{background:var(--border);border:1px solid var(--border);border-radius:12px;padding:10px 12px;min-width:120px}
  .count b{display:block;font-size:18px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
  .tab{cursor:pointer;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:var(--border);color:var(--muted);font-weight:600;font-size:13px}
  .tab.active{background:var(--border);color:var(--text);border-color:var(--border)}
  pre{white-space:pre-wrap;word-break:break-word;background:var(--border);border:1px solid var(--border);border-radius:12px;padding:12px;min-height:220px;max-height:420px;overflow:auto}
  .ok{color:var(--good)}
  .bad{color:var(--bad)}
  .chk{display:flex;gap:10px;flex-wrap:wrap}
  label{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px}
  .footer{max-width:1200px;margin:0 auto;padding:0 18px 28px;color:var(--muted);font-size:12px}
  @media (max-width: 980px){.wrap{grid-template-columns:1fr}}

  .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .hdr-actions{display:flex;align-items:center;gap:10px;margin-top:4px}
  .toggle{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:600}
  .toggle:hover{border-color:var(--accent)}
  .footer{max-width:1200px;margin:0 auto;padding:0 18px 24px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}


  .dash{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:14px}
  .dashcard{background:var(--card2);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
  .dashhead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .dashhead .title{font-weight:700;font-size:13px;color:var(--text)}
  .dashhead .subtitle{font-size:12px;color:var(--muted)}
  .donut{display:flex;gap:12px;align-items:center}
  .donut canvas{width:84px;height:84px}
  .legend{display:grid;gap:6px;font-size:12px;color:var(--muted)}
  .legend .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .sw{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:8px;border:1px solid var(--border)}
  .countgrid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px;margin-top:10px}
  .count{background:var(--card2);border:1px solid var(--border);border-radius:14px;padding:10px;box-shadow:var(--shadow)}
  @media (max-width: 980px){.dash{grid-template-columns:1fr}.countgrid{grid-template-columns:repeat(2,1fr)}}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;flex:0 0 28px}
  .wordmark{display:flex;flex-direction:column;gap:2px}
  .wordmark .name{font-size:28px;margin:0;letter-spacing:.2px}
  .wordmark .tag{font-size:12px;color:var(--muted);margin-top:-2px}
  .toggle{background:var(--card2)}

  /* v3.1 palette cleanup */
  .textarea, textarea, pre, .outbox{
    background: var(--input) !important;
    border-color: var(--border) !important;
  }
  .outarea, .output, .outputs, .tabs, .tabbar{
    background: transparent;
  }
  .tabs .tab.active, .tabs .tab:hover{
    border-color: var(--accent) !important;
    color: var(--text) !important;
  }
  a, .creator a{ color: var(--accent) !important; }
  .donut-card .legend-dot{ box-shadow: 0 0 0 3px rgba(255,138,0,.12); }

.icon-link{display:inline-flex;align-items:center;vertical-align:middle;color:var(--muted);text-decoration:none;margin-left:6px}
.icon-link:hover{color:var(--text)}
.icon-link svg{width:16px;height:16px;display:block}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div>
      <div class="brand"><svg class="logo" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M32 4L10 14v18c0 14 9 24 22 28 13-4 22-14 22-28V14L32 4z" fill="none" stroke="var(--accent)" stroke-width="4"/><path d="M22 26h20M22 38h14" fill="none" stroke="var(--accent)" stroke-width="4" stroke-linecap="round"/></svg><div class="wordmark"><div class="name">Forge<span style="color:var(--accent)">IOC</span></div><div class="tag">Offline IOC parser</div></div></div>
      <div class="sub">Offline IOC parser + FortiGate CLI script generator. Paste or upload IOCs, validate/normalize, filter hashes, then generate clean outputs.</div>
      <div class="creator">Creator: <b>Dhaidan Aljumah</b> — <a class="icon-link" href="https://linkedin.com/in/dhaidan" target="_blank" rel="noopener" aria-label="LinkedIn"><svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4.98 3.5C4.98 4.88 3.87 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.48 1.12 2.48 2.5ZM.5 23.5h4V7.98h-4V23.5ZM8.5 7.98h3.83v2.12h.05c.53-1 1.83-2.12 3.77-2.12 4.03 0 4.78 2.65 4.78 6.1v9.42h-4v-8.35c0-1.99-.04-4.55-2.77-4.55-2.78 0-3.2 2.17-3.2 4.41v8.49h-4V7.98Z"/></svg></a></div>
    </div>
    <div class="hdr-actions">
      <button class="toggle" id="themeBtn" type="button" aria-label="Toggle theme">Toggle theme</button>
    </div>
  </div>
  <div id="dashboard"></div>
  <div class="counts" id="counts"></div>
</header>

<div class="wrap">
  <section class="card">
    <h2>Input</h2>
    <div class="row">
      <input type="file" id="file" accept=".txt,.csv,.log,.ioc,.json,.md,.rtf,.html,.xml"/>
      <button class="btn ghost" id="clearBtn">Clear</button>
      <button class="btn primary" id="parseBtn">Parse & Generate</button>
    </div>
    <div style="height:10px"></div>
    <textarea id="input" placeholder="Paste IOCs here...&#10;Examples:&#10;1.2.3.4&#10;hxxps://evil[.]tld/path&#10;example.com&#10;SHA256: a3f1... (64 hex)"></textarea>

    <div style="height:12px"></div>
    <div class="grid2">
      <div>
        <div class="small">Hash filtering (output only)</div>
        <div class="chk" style="margin-top:8px">
          <label><input type="checkbox" id="allow_md5" checked/> MD5 (32)</label>
          <label><input type="checkbox" id="allow_sha1"/> SHA1 (40)</label>
          <label><input type="checkbox" id="allow_sha256" checked/> SHA256 (64)</label>
          <label><input type="checkbox" id="allow_sha512"/> SHA512 (128)</label>
        </div>
      </div>
      <div>
        <div class="small">Normalization</div>
        <div class="chk" style="margin-top:8px">
          <label><input type="checkbox" id="normalize_defang" checked/> Defang URLs (hxxp / [.] )</label>
          <label><input type="checkbox" id="dedupe" checked/> Dedupe</label>
          <label><input type="checkbox" id="sort" checked/> Sort</label>
        </div>
      </div>
    </div>
  </section>

  <aside class="card">
    <h2>FortiGate</h2>
    <div class="grid2">
      <div>
        <div class="small">Object prefix</div>
        <input id="fg_prefix" value="IOC_" />
      </div>
      <div>
        <div class="small">Address group name</div>
        <input id="fg_group" value="IOC_BLOCKLIST" />
      </div>
      <div>
        <div class="small">VDOM (optional)</div>
        <input id="fg_vdom" placeholder="root" />
      </div>
      <div>
        <div class="small">Policy ID (optional)</div>
        <input id="fg_policy" placeholder="e.g., 123" />
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="grid2">
      <div>
        <div class="small">Attach to policy field</div>
        <select id="fg_field">
          <option value="dstaddr">dstaddr</option>
          <option value="srcaddr">srcaddr</option>
        </select>
      </div>
      <div>
        <div class="small">Object naming</div>
        <select id="fg_naming">
          <option value="prefix_value">prefix + value</option>
          <option value="value_only">value only</option>
        </select>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="chk">
      <label><input type="checkbox" id="fg_create_addr" checked/> Create address objects (IP/FQDN)</label>
      <label><input type="checkbox" id="fg_addrgrp" checked/> Add objects to addrgrp</label>
      <label><input type="checkbox" id="fg_attach_policy"/> Attach addrgrp to policy (requires Policy ID)</label>
    </div>

    <div style="height:10px"></div>
    <button class="btn primary" id="genFortiBtn">Generate FortiGate CLI</button>
    <div class="small" style="margin-top:10px">Notes: URLs are not firewall address objects (better in URL filter). Hashes are for EDR/AV, not the firewall.</div>
  </aside>

  <section class="card" style="grid-column: 1 / -1;">
    <h2>Outputs</h2>
    <div class="tabs" id="tabs"></div>
    <pre id="output">(Parse input to see outputs)</pre>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="copyBtn">Copy</button>
      <button class="btn" id="downloadBtn">Download .txt</button>
    </div>
  </section>

  <section class="card" style="grid-column: 1 / -1;">
    <h2>Warnings / Data Quality</h2>
    <pre id="warnings">(No warnings)</pre>
  </section>
</div>

<div class="footer">
  Offline by design. No network calls. Keep this file locally. If you share it, review your organization’s policy.
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const state = {
    parsed: null,
    outputs: {},
    currentTab: null
  };

  // Theme toggle (offline-friendly)
  const THEME_KEY = "forgeioc_theme";
  function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    const btn = $("themeBtn");
    if (btn){
      btn.textContent = theme === "light" ? "Dark mode" : "Light mode";
    }
  }
  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if (saved === "light" || saved === "dark"){
      applyTheme(saved);
    } else {
      // default: dark
      applyTheme("dark");
    }
    const btn = $("themeBtn");
    if (btn){
      btn.addEventListener("click", () => {
        const current = document.documentElement.getAttribute("data-theme") || "dark";
        const next = current === "light" ? "dark" : "light";
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next);
      });
    }
  }


  function isHex(s){ return /^[0-9a-fA-F]+$/.test(s); }

  function defangToFang(s){
    // common defanging
    return s
      .replace(/hxxps?:/gi, (m)=> m.toLowerCase().replace("hxxp","http"))
      .replace(/\[\.\]/g, ".")
      .replace(/\(\.\)/g, ".")
      .replace(/\{\.\}/g, ".")
      .replace(/\[dot\]/gi, ".")
      .replace(/\(dot\)/gi, ".")
      .replace(/\{dot\}/gi, ".")
      .replace(/\s+\[\.\]\s+/g, ".")
      .replace(/\s+\(\.\)\s+/g, ".")
      .replace(/\s+\{\.\}\s+/g, ".")
      .replace(/\s+\[dot\]\s+/gi, ".")
      .replace(/\s+\(dot\)\s+/gi, ".")
      .replace(/\s+\{dot\}\s+/gi, ".")
      .replace(/\[\s*\.\s*\]/g, ".")
      .replace(/\(\s*\.\s*\)/g, ".")
      .replace(/\{\s*\.\s*\}/g, ".")
      .replace(/\[\s*dot\s*\]/gi, ".")
      .replace(/\(\s*dot\s*\)/gi, ".")
      .replace(/\{\s*dot\s*\}/gi, ".");
  }

  function extractTokens(raw){
    // Split aggressively, keep URLs intact-ish
    const lines = raw.split(/\r?\n/);
    const tokens = [];
    for (const line of lines){
      const trimmed = line.trim();
      if (!trimmed) continue;
      // keep whole line token too (for label checks)
      tokens.push(trimmed);
      // also split on common separators
      const parts = trimmed.split(/[\s,;|]+/).map(p=>p.trim()).filter(Boolean);
      for (const p of parts) tokens.push(p);
    }
    return tokens;
  }

  function normalizeMaybe(s){
    let out = s.trim();
    if ($("normalize_defang").checked) out = defangToFang(out);
    // Remove surrounding quotes/brackets
    out = out.replace(/^['"\[\(\{<]+/,"").replace(/['"\]\)\}>]+$/,"");
    return out;
  }

  const reIPv4 = /^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$/;
  const reURL  = /^(https?:\/\/)[^\s/$.?#].[^\s]*$/i;
  const reDomain = /^(?=.{1,253}$)(?!-)(?:[a-zA-Z0-9-]{1,63}\.)+[a-zA-Z]{2,63}$/;
  const reEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  function detectHashType(hex){
    const len = hex.length;
    if (!isHex(hex)) return null;
    if (len === 32) return "MD5";
    if (len === 40) return "SHA1";
    if (len === 64) return "SHA256";
    if (len === 128) return "SHA512";
    return null;
  }

  function allowHash(type){
    if (type === "MD5") return $("allow_md5").checked;
    if (type === "SHA1") return $("allow_sha1").checked;
    if (type === "SHA256") return $("allow_sha256").checked;
    if (type === "SHA512") return $("allow_sha512").checked;
    return false;
  }

  function sanitizeForFortiName(s){
    // Forti object name rules vary; keep conservative
    // Replace spaces and problematic characters
    return s.replace(/[^a-zA-Z0-9._-]/g, "_").slice(0, 63);
  }

  function fortiObjectName(value){
    const naming = $("fg_naming").value;
    if (naming === "value_only") return sanitizeForFortiName(value);
    return sanitizeForFortiName(($("fg_prefix").value || "IOC_") + value);
  }

  function parseAll(){
    const raw = $("input").value || "";
    const tokens = extractTokens(raw).map(normalizeMaybe).filter(Boolean);

    const ips = [];
    const urls = [];
    const fqdns = [];
    const hashes = { MD5: [], SHA1: [], SHA256: [], SHA512: [] };
    const warnings = [];
    const excluded = { hashes: {MD5:0,SHA1:0,SHA256:0,SHA512:0}, emails:0, invalidLabeled:0 };

    // label-based expectations
    const labelExpect = (token) => {
      const t = token.toUpperCase();
      if (t.includes("SHA256")) return "SHA256";
      if (t.includes("SHA1")) return "SHA1";
      if (t.includes("MD5")) return "MD5";
      if (t.includes("SHA512")) return "SHA512";
      return null;
    };

    for (const tok0 of tokens){
      const tok = tok0.trim();
      if (!tok) continue;

      // strip leading label like "SHA256:" or "MD5="
      let stripped = tok.replace(/^\s*(SHA256|SHA1|MD5|SHA512)\s*[:=]\s*/i, "").trim();
      if (stripped === tok) stripped = tok; // no change

      // Emails are not enforced on firewall/EDR queries here; track as excluded
      if (reEmail.test(stripped)) { excluded.emails++; continue; }

      // hash detect (by pure hex and length)
      const htype = detectHashType(stripped);
      const expected = labelExpect(tok);

      if (htype){
        if (expected && expected !== htype){
          warnings.push(`Label mismatch: expected ${expected} but detected ${htype} → ${stripped}`);
        }
        if (allowHash(htype)) {
          hashes[htype].push(stripped.toLowerCase());
        } else {
          excluded.hashes[htype]++;
        }
        continue;
      } else if (expected){
        // labeled but not valid hex/length
        excluded.invalidLabeled++;
        warnings.push(`Labeled ${expected} but invalid hash value → ${tok}`);
      }

      // URL detect
      if (reURL.test(stripped)){
        urls.push(stripped);
        continue;
      }

      // IPv4 detect
      if (reIPv4.test(stripped)){
        ips.push(stripped);
        continue;
      }

      // domain detect (strip protocol/path if user pasted)
      // Try to salvage URLs without scheme: example.com/path
      const maybeHost = stripped
        .replace(/^\s*(?:https?:\/\/)?/i,"")
        .split("/")[0]
        .split(":")[0]
        .trim();

      if (reDomain.test(maybeHost)){
        fqdns.push(maybeHost.toLowerCase());
        continue;
      }
    }

    const normList = (arr) => {
      let out = arr.slice();
      if ($("dedupe").checked){
        out = Array.from(new Set(out));
      }
      if ($("sort").checked){
        out.sort((a,b)=> a.localeCompare(b));
      }
      return out;
    };

    const parsed = {
      ips: normList(ips),
      fqdns: normList(fqdns),
      urls: normList(urls),
      hashes: {
        MD5: normList(hashes.MD5),
        SHA1: normList(hashes.SHA1),
        SHA256: normList(hashes.SHA256),
        SHA512: normList(hashes.SHA512),
      },
      warnings,
      excluded
    };

    state.parsed = parsed;
    buildOutputs();
    renderCounts();
    renderWarnings();
    renderTabs();
    selectTab(state.currentTab || "IPs");
  }

  
  function drawDonut(canvasId, parts){
    const c = document.getElementById(canvasId);
    if (!c) return;
    const ctx = c.getContext("2d");
    const dpr = window.devicePixelRatio || 1;
    const size = 92;
    c.width = size * dpr;
    c.height = size * dpr;
    c.style.width = size + "px";
    c.style.height = size + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,size,size);

    const total = parts.reduce((a,p)=>a+p.value,0) || 1;
    const cx = size/2, cy = size/2;
    const r = 36, w = 10;
    let start = -Math.PI/2;

    // track colors
    const css = getComputedStyle(document.documentElement);
    const accent = css.getPropertyValue("--accent").trim();
    const good = css.getPropertyValue("--good").trim();
    const bad  = css.getPropertyValue("--bad").trim();
    const muted= css.getPropertyValue("--border").trim();

    const palette = [accent, good, "#60a5fa", "#a78bfa", "#fbbf24", bad, muted];

    parts.forEach((p,i)=>{
      const ang = (p.value/total) * Math.PI * 2;
      ctx.beginPath();
      ctx.arc(cx,cy,r,start,start+ang);
      ctx.strokeStyle = p.color || palette[i % palette.length];
      ctx.lineWidth = w;
      ctx.lineCap = "butt";
      ctx.stroke();
      start += ang;
    });

    // inner hole
    ctx.beginPath();
    ctx.arc(cx,cy,r-w,0,Math.PI*2);
    ctx.fillStyle = css.getPropertyValue("--card2").trim() || "#111";
    ctx.fill();

    // center total
    ctx.fillStyle = css.getPropertyValue("--text").trim() || "#fff";
    ctx.font = "700 16px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(String(total), cx, cy-2);
    ctx.fillStyle = css.getPropertyValue("--muted").trim() || "#aaa";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillText("IOCs", cx, cy+14);
  }

  function dashCard(title, subtitle, canvasId, legendRows){
    return `
      <div class="dashcard">
        <div class="dashhead">
          <div>
            <div class="title">${title}</div>
            <div class="subtitle">${subtitle}</div>
          </div>
        </div>
        <div class="donut">
          <canvas id="${canvasId}"></canvas>
          <div class="legend">
            ${legendRows.join("")}
          </div>
        </div>
      </div>`;
  }
function renderCounts(){
    const p = state.parsed;

    const fwReady = (p.ips.length + p.fqdns.length);
    const excludedHashes =
      (p.excluded?.hashes?.MD5||0) + (p.excluded?.hashes?.SHA1||0) + (p.excluded?.hashes?.SHA256||0) + (p.excluded?.hashes?.SHA512||0);
    const excludedTotal = (p.urls.length) + excludedHashes + (p.excluded?.emails||0) + (p.excluded?.invalidLabeled||0);

    // Dashboard (donuts)
    const dash = document.getElementById("dashboard");
    if (dash){
      const breakdownLegend = [
        `<div class="row"><span><span class="sw" style="background:var(--accent)"></span>IPs</span><b>${p.ips.length}</b></div>`,
        `<div class="row"><span><span class="sw" style="background:var(--good)"></span>FQDN</span><b>${p.fqdns.length}</b></div>`,
        `<div class="row"><span><span class="sw" style="background:#60a5fa"></span>URLs</span><b>${p.urls.length}</b></div>`,
        `<div class="row"><span><span class="sw" style="background:#a78bfa"></span>Hashes</span><b>${p.hashes.MD5.length + p.hashes.SHA1.length + p.hashes.SHA256.length + p.hashes.SHA512.length}</b></div>`
      ];
      const fwLegend = [
        `<div class="row"><span><span class="sw" style="background:var(--good)"></span>Ready</span><b>${fwReady}</b></div>`,
        `<div class="row"><span><span class="sw" style="background:#fbbf24"></span>Excluded</span><b>${excludedTotal}</b></div>`,
        `<div class="row"><span><span class="sw" style="background:var(--bad)"></span>Issues</span><b>${p.warnings.length}</b></div>`
      ];
      const hashLegend = [
        `<div class="row"><span><span class="sw" style="background:var(--accent)"></span>SHA256</span><b>${p.hashes.SHA256.length}</b></div>`,
        `<div class="row"><span><span class="sw" style="background:#60a5fa"></span>MD5</span><b>${p.hashes.MD5.length}</b></div>`,
        `<div class="row"><span><span class="sw" style="background:var(--bad)"></span>SHA1</span><b>${p.hashes.SHA1.length}</b></div>`,
        `<div class="row"><span><span class="sw" style="background:#a78bfa"></span>SHA512</span><b>${p.hashes.SHA512.length}</b></div>`
      ];

      dash.innerHTML = `
        <div class="dash">
          ${dashCard("IOC Breakdown","What was detected", "donutBreakdown", breakdownLegend)}
          ${dashCard("Firewall Readiness","What can be pushed to FortiGate", "donutFirewall", fwLegend)}
          ${dashCard("Hash Types","Validate & filter before EDR/AV", "donutHashes", hashLegend)}
        </div>
      `;

      drawDonut("donutBreakdown", [
        {label:"IPs", value:p.ips.length, color:getComputedStyle(document.documentElement).getPropertyValue("--accent").trim()},
        {label:"FQDN", value:p.fqdns.length, color:getComputedStyle(document.documentElement).getPropertyValue("--good").trim()},
        {label:"URLs", value:p.urls.length, color:"#60a5fa"},
        {label:"Hashes", value:(p.hashes.MD5.length + p.hashes.SHA1.length + p.hashes.SHA256.length + p.hashes.SHA512.length), color:"#a78bfa"}
      ]);

      drawDonut("donutFirewall", [
        {label:"Ready", value:fwReady, color:getComputedStyle(document.documentElement).getPropertyValue("--good").trim()},
        {label:"Excluded", value:excludedTotal, color:"#fbbf24"},
        {label:"Issues", value:p.warnings.length, color:getComputedStyle(document.documentElement).getPropertyValue("--bad").trim()}
      ]);

      drawDonut("donutHashes", [
        {label:"SHA256", value:p.hashes.SHA256.length, color:getComputedStyle(document.documentElement).getPropertyValue("--accent").trim()},
        {label:"MD5", value:p.hashes.MD5.length, color:"#60a5fa"},
        {label:"SHA1", value:p.hashes.SHA1.length, color:getComputedStyle(document.documentElement).getPropertyValue("--bad").trim()},
        {label:"SHA512", value:p.hashes.SHA512.length, color:"#a78bfa"}
      ]);
    }

    const counts = [
      ["Firewall-ready (IP+FQDN)", fwReady],
      ["Excluded (not applicable/unsupported)", excludedTotal],
      ["Issues (warnings)", p.warnings.length],
      ["IPs", p.ips.length],
      ["FQDNs", p.fqdns.length],
      ["URLs", p.urls.length],
      ["MD5", p.hashes.MD5.length],
      ["SHA256", p.hashes.SHA256.length],
      ["SHA1", p.hashes.SHA1.length],
      ["SHA512", p.hashes.SHA512.length],
      ["Invalid labeled", (p.excluded?.invalidLabeled||0)]
    ];

    document.getElementById("counts").innerHTML =
      `<div class="countgrid">` +
      counts.map(([k,v]) =>
        `<div class="count"><b>${v}</b><div class="small">${k}</div></div>`
      ).join("") +
      `</div>`;
  }

  function renderWarnings(){
    const p = state.parsed;
    $("warnings").textContent = p.warnings.length ? p.warnings.join("\n") : "(No warnings)";
  }

  function buildOutputs(){
    const p = state.parsed;

    const outputs = {};

    outputs["IPs"] = p.ips.join("\n");
    outputs["FQDNs"] = p.fqdns.join("\n");
    outputs["URLs"] = p.urls.join("\n");

    outputs["Hashes (All Allowed)"] = [
      ...p.hashes.MD5.map(h=>`MD5: ${h}`),
      ...p.hashes.SHA1.map(h=>`SHA1: ${h}`),
      ...p.hashes.SHA256.map(h=>`SHA256: ${h}`),
      ...p.hashes.SHA512.map(h=>`SHA512: ${h}`)
    ].join("\n");

    outputs["Defender (KQL) - IP"] =
      p.ips.length
        ? `DeviceNetworkEvents\n| where RemoteIP in~ (${p.ips.map(x=>`"${x}"`).join(", ")})\n| order by Timestamp desc`
        : "";

    outputs["Defender (KQL) - FQDN"] =
      p.fqdns.length
        ? `DeviceNetworkEvents\n| where RemoteUrl has_any (${p.fqdns.map(x=>`"${x}"`).join(", ")})\n| order by Timestamp desc`
        : "";

    outputs["Splunk (SPL) - IP"] =
      p.ips.length
        ? `| tstats count latest(_time) as latest earliest(_time) as earliest from datamodel=Network_Traffic.All_Traffic where All_Traffic.src IN (${p.ips.map(x=>`"${x}"`).join(",")}) by All_Traffic.src All_Traffic.dest All_Traffic.app All_Traffic.action All_Traffic.user All_Traffic.vendor_product\n| eval latest=ctime(latest), earliest=ctime(earliest)`
        : "";

    outputs["Splunk (SPL) - FQDN"] =
      p.fqdns.length
        ? `index=* (${p.fqdns.map(x=>`"${x}"`).join(" OR ")})\n| stats count by host, sourcetype`
        : "";

    outputs["FortiGate CLI (Generated)"] = generateFortiCLI(true);

    outputs["JSON"] = JSON.stringify(p, null, 2);

    state.outputs = outputs;
    state.currentTab = state.currentTab && outputs[state.currentTab] !== undefined ? state.currentTab : "IPs";
  }

  function generateFortiCLI(asPreview){
    const p = state.parsed || {ips:[], fqdns:[]};
    const vdom = ($("fg_vdom").value || "").trim();
    const group = ($("fg_group").value || "IOC_BLOCKLIST").trim();
    const policyId = ($("fg_policy").value || "").trim();
    const field = $("fg_field").value;

    const createAddr = $("fg_create_addr").checked;
    const addGrp = $("fg_addrgrp").checked;
    const attach = $("fg_attach_policy").checked && policyId;

    const lines = [];
if (vdom){
      lines.push(`config vdom`);
      lines.push(`edit ${vdom}`);
      lines.push("");
    }

    const members = [];

    if (createAddr){
      lines.push(`config firewall address`);

      for (const ip of p.ips){
        const name = fortiObjectName(ip);
        members.push(name);
        lines.push(`    edit "${name}"`);
        lines.push(`        set subnet ${ip} 255.255.255.255`);
        lines.push(`    next`);
      }

      for (const d of p.fqdns){
        const name = fortiObjectName(d);
        members.push(name);
        lines.push(`    edit "${name}"`);
        lines.push(`        set type fqdn`);
        lines.push(`        set fqdn "${d}"`);
        lines.push(`    next`);
      }

      lines.push(`end`);
      lines.push("");
    } else {
      // if not creating, still can add group members (assumes they already exist)
      for (const ip of p.ips) members.push(fortiObjectName(ip));
      for (const d of p.fqdns) members.push(fortiObjectName(d));
    }

    if (addGrp){
      lines.push(`config firewall addrgrp`);
      lines.push(`    edit "${group}"`);
      for (const m of members){
        lines.push(`        append member "${m}"`);
      }
      lines.push(`    next`);
      lines.push(`end`);
      lines.push("");
    }

    if (attach){
      lines.push(`config firewall policy`);
      lines.push(`    edit ${policyId}`);
      lines.push(`        append ${field} "${group}"`);
      lines.push(`    next`);
      lines.push(`end`);
      lines.push("");
    } else if ($("fg_attach_policy").checked && !policyId){
      lines.push(`# NOTE: "Attach addrgrp to policy" is enabled but Policy ID is empty.`);
      lines.push(`#       Set Policy ID then regenerate.`);
      lines.push("");
    }

    if (vdom){
      lines.push(`end`);
      lines.push("");
    }

    return lines.join("\n");
  }

  function renderTabs(){
    const tabs = Object.keys(state.outputs);
    const preferredOrder = [
      "IPs","FQDNs","URLs",
      "Hashes (All Allowed)",
      "FortiGate CLI (Generated)",
      "Defender (KQL) - IP","Defender (KQL) - FQDN",
      "Splunk (SPL) - IP","Splunk (SPL) - FQDN",
      "JSON"
    ];
    const ordered = preferredOrder.filter(t=>tabs.includes(t)).concat(tabs.filter(t=>!preferredOrder.includes(t)));
    $("tabs").innerHTML = ordered.map(t => `<div class="tab" data-tab="${t}">${t}</div>`).join("");
    for (const el of $("tabs").querySelectorAll(".tab")){
      el.addEventListener("click", ()=> selectTab(el.getAttribute("data-tab")));
    }
  }

  function selectTab(name){
    state.currentTab = name;
    const tabs = $("tabs").querySelectorAll(".tab");
    tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === name));
    const val = state.outputs[name] || "";
    $("output").textContent = val || "(No output for this tab)";
  }

  async function copyCurrent(){
    const text = $("output").textContent || "";
    try{
      await navigator.clipboard.writeText(text);
      flash("Copied ✅");
    }catch{
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      flash("Copied ✅");
    }
  }

  function downloadCurrent(){
    const name = (state.currentTab || "output").replace(/[^a-zA-Z0-9._-]/g,"_") + ".txt";
    const blob = new Blob([$("output").textContent || ""], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function flash(msg){
    const el = document.createElement("div");
    el.className = "pill";
    el.style.position="fixed";
    el.style.right="14px";
    el.style.bottom="14px";
    el.style.zIndex="9999";
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 1400);
  }

  // Events
  $("parseBtn").addEventListener("click", parseAll);
  $("clearBtn").addEventListener("click", ()=> { $("input").value=""; state.parsed=null; state.outputs={}; $("output").textContent="(Parse input to see outputs)"; $("warnings").textContent="(No warnings)"; $("counts").innerHTML=""; $("tabs").innerHTML=""; });
  $("copyBtn").addEventListener("click", copyCurrent);
  $("downloadBtn").addEventListener("click", downloadCurrent);

  $("genFortiBtn").addEventListener("click", ()=>{
    if (!state.parsed){ flash("Parse input first"); return; }
    state.outputs["FortiGate CLI (Generated)"] = generateFortiCLI(false);
    renderTabs();
    selectTab("FortiGate CLI (Generated)");
    flash("FortiGate script generated ✅");
  });

  $("file").addEventListener("change", async (e)=>{
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const text = await f.text();
    $("input").value = text;
    flash("File loaded ✅");
  });

  initTheme();
})();
</script>

<div class="footer">
  <div>ForgeIOC — Offline IOC Parser &amp; FortiGate CLI Generator</div>
  <div>Created by Dhaidan Aljumah • <a class="icon-link" href="https://linkedin.com/in/dhaidan" target="_blank" rel="noopener" aria-label="LinkedIn"><svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4.98 3.5C4.98 4.88 3.87 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.48 1.12 2.48 2.5ZM.5 23.5h4V7.98h-4V23.5ZM8.5 7.98h3.83v2.12h.05c.53-1 1.83-2.12 3.77-2.12 4.03 0 4.78 2.65 4.78 6.1v9.42h-4v-8.35c0-1.99-.04-4.55-2.77-4.55-2.78 0-3.2 2.17-3.2 4.41v8.49h-4V7.98Z"/></svg></a></div>
</div>
</body>
</html>
